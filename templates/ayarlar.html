{% extends 'base.html' %}

{% block title %}Ayarlar{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-5 fw-bold">
        <i class="bi bi-gear"></i> Sistem Ayarları
    </h1>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Ana Sayfa
    </a>
</div>

<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> 
    <strong>Bilgi:</strong> Tüm ağırlıkların toplamı 100 olmalıdır.
</div>

<div class="card">
    <div class="card-body">
        <form method="POST">
            <h5 class="mb-4"><i class="bi bi-clipboard-check"></i> Değerlendirme Kriterleri Ağırlıkları</h5>

            <div class="d-flex flex-wrap gap-2 mb-4">
                <button type="button" class="btn btn-outline-success btn-sm" id="kriter-normalize">
                    <i class="bi bi-magic"></i> Kriterleri 100'e Düzelt
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="preset-dengeli">
                    <i class="bi bi-sliders"></i> Dengeli (Varsayılan)
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="preset-sunum">
                    <i class="bi bi-easel2"></i> Görsellik Ağırlıklı
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="preset-not-dengeli">
                    <i class="bi bi-calculator"></i> Not: 60/40
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="preset-not-ogretmen">
                    <i class="bi bi-person-badge"></i> Not: 70/30
                </button>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Konu Hakimiyeti Ağırlığı (%)</label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range weight-range" min="0" max="100" step="1" value="{{ ayarlar.konu_hakimiyeti_agirlik }}" data-target="konu_hakimiyeti_agirlik" style="flex: 1;">
                        <span class="badge bg-primary" data-badge="konu_hakimiyeti_agirlik">0%</span>
                    </div>
                    <input type="hidden" class="weight-input" name="konu_hakimiyeti_agirlik" value="{{ ayarlar.konu_hakimiyeti_agirlik }}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Anlatım Ağırlığı (%)</label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range weight-range" min="0" max="100" step="1" value="{{ ayarlar.anlatim_agirlik }}" data-target="anlatim_agirlik" style="flex: 1;">
                        <span class="badge bg-primary" data-badge="anlatim_agirlik">0%</span>
                    </div>
                    <input type="hidden" class="weight-input" name="anlatim_agirlik" value="{{ ayarlar.anlatim_agirlik }}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Giyim Ağırlığı (%)</label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range weight-range" min="0" max="100" step="1" value="{{ ayarlar.giyim_agirlik }}" data-target="giyim_agirlik" style="flex: 1;">
                        <span class="badge bg-primary" data-badge="giyim_agirlik">0%</span>
                    </div>
                    <input type="hidden" class="weight-input" name="giyim_agirlik" value="{{ ayarlar.giyim_agirlik }}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Ekip Uyumu Ağırlığı (%)</label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range weight-range" min="0" max="100" step="1" value="{{ ayarlar.ekip_uyumu_agirlik }}" data-target="ekip_uyumu_agirlik" style="flex: 1;">
                        <span class="badge bg-primary" data-badge="ekip_uyumu_agirlik">0%</span>
                    </div>
                    <input type="hidden" class="weight-input" name="ekip_uyumu_agirlik" value="{{ ayarlar.ekip_uyumu_agirlik }}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Görsellik Ağırlığı (%)</label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range weight-range" min="0" max="100" step="1" value="{{ ayarlar.gorsellik_agirlik }}" data-target="gorsellik_agirlik" style="flex: 1;">
                        <span class="badge bg-primary" data-badge="gorsellik_agirlik">0%</span>
                    </div>
                    <input type="hidden" class="weight-input" name="gorsellik_agirlik" value="{{ ayarlar.gorsellik_agirlik }}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Genel Görüş Ağırlığı (%)</label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range weight-range" min="0" max="100" step="1" value="{{ ayarlar.genel_gorus_agirlik }}" data-target="genel_gorus_agirlik" style="flex: 1;">
                        <span class="badge bg-primary" data-badge="genel_gorus_agirlik">0%</span>
                    </div>
                    <input type="hidden" class="weight-input" name="genel_gorus_agirlik" value="{{ ayarlar.genel_gorus_agirlik }}" required>
                </div>
            </div>
            
            <div class="mb-4">
                <div class="alert alert-secondary">
                    <strong>Kriterler Toplamı:</strong> 
                    <span id="kriter-toplam">0</span>%
                </div>
            </div>

            <hr class="my-4">

            <h5 class="mb-4"><i class="bi bi-fonts"></i> Kriter Başlıkları</h5>

            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">1. Başlık</label>
                    <input type="text" class="form-control" name="konu_hakimiyeti_etiket" value="{{ ayarlar.konu_hakimiyeti_etiket or 'Konu Hakimiyeti' }}" maxlength="200" required>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">2. Başlık</label>
                    <input type="text" class="form-control" name="anlatim_etiket" value="{{ ayarlar.anlatim_etiket or 'Anlatım' }}" maxlength="200" required>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">3. Başlık</label>
                    <input type="text" class="form-control" name="giyim_etiket" value="{{ ayarlar.giyim_etiket or 'Giyim' }}" maxlength="200" required>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">4. Başlık</label>
                    <input type="text" class="form-control" name="ekip_uyumu_etiket" value="{{ ayarlar.ekip_uyumu_etiket or 'Ekip Uyumu ve Görev Paylaşımı' }}" maxlength="200" required>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">5. Başlık</label>
                    <input type="text" class="form-control" name="gorsellik_etiket" value="{{ ayarlar.gorsellik_etiket or 'Görsellik' }}" maxlength="200" required>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">6. Başlık</label>
                    <input type="text" class="form-control" name="genel_gorus_etiket" value="{{ ayarlar.genel_gorus_etiket or 'Genel Görüş' }}" maxlength="200" required>
                </div>
            </div>
            
            <hr class="my-4">
            
            <h5 class="mb-4"><i class="bi bi-calculator"></i> Final Not Hesaplama Ağırlıkları</h5>

            <div class="alert alert-light border" role="alert" style="border-left: 4px solid #6b7280;">
                <i class="bi bi-link-45deg"></i>
                <strong>Bilgi:</strong> Öğretmen ve öğrenci ağırlıkları birbirine bağlıdır; toplam otomatik olarak <strong>100</strong> tutulur.
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Öğretmen Notu Ağırlığı (%)</label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range weight-range" min="0" max="100" step="0.1" value="{{ ayarlar.ogretmen_notu_agirlik }}" data-target="ogretmen_notu_agirlik" style="flex: 1;">
                        <span class="badge bg-secondary" data-badge="ogretmen_notu_agirlik">0%</span>
                    </div>
                    <input type="hidden" class="weight-input" name="ogretmen_notu_agirlik" value="{{ ayarlar.ogretmen_notu_agirlik }}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Öğrenci Notu Ağırlığı (%)</label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range weight-range" min="0" max="100" step="0.1" value="{{ ayarlar.ogrenci_notu_agirlik }}" data-target="ogrenci_notu_agirlik" style="flex: 1;">
                        <span class="badge bg-secondary" data-badge="ogrenci_notu_agirlik">0%</span>
                    </div>
                    <input type="hidden" class="weight-input" name="ogrenci_notu_agirlik" value="{{ ayarlar.ogrenci_notu_agirlik }}" required>
                </div>
            </div>
            
            <div class="mb-4">
                <div class="alert alert-secondary">
                    <strong>Not Hesaplama Toplamı:</strong> 
                    <span id="not-toplam">0</span>%
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="save-btn" disabled>
                    <i class="bi bi-save"></i> Ayarları Kaydet
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-x-circle"></i> İptal
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function setValue(name, value) {
        const hidden = document.querySelector(`input.weight-input[name="${name}"]`);
        if (hidden) {
            hidden.value = value;
        }
        const range = document.querySelector(`input.weight-range[data-target="${name}"]`);
        if (range) {
            range.value = value;
        }
        const badge = document.querySelector(`[data-badge="${name}"]`);
        if (badge) {
            const kriterNames = [
                'konu_hakimiyeti_agirlik',
                'anlatim_agirlik',
                'giyim_agirlik',
                'ekip_uyumu_agirlik',
                'gorsellik_agirlik',
                'genel_gorus_agirlik'
            ];
            if (kriterNames.includes(name)) {
                badge.textContent = `${Math.round(parseFloat(value || 0))}%`;
            } else {
                badge.textContent = `${parseFloat(value || 0).toFixed(1)}%`;
            }
        }
    }

    function syncFromRange(rangeEl) {
        const name = rangeEl.getAttribute('data-target');
        const value = rangeEl.value;
        setValue(name, value);
    }

    function hesaplaKriterToplam() {
        const kriterler = [
            'konu_hakimiyeti_agirlik',
            'anlatim_agirlik',
            'giyim_agirlik',
            'ekip_uyumu_agirlik',
            'gorsellik_agirlik',
            'genel_gorus_agirlik'
        ];
        
        let toplam = 0;
        kriterler.forEach(name => {
            const input = document.querySelector(`[name="${name}"]`);
            if (input) {
                toplam += parseFloat(input.value) || 0;
            }
        });
        
        const toplamElement = document.getElementById('kriter-toplam');
        toplamElement.textContent = toplam.toFixed(2);
        
        if (Math.abs(toplam - 100) < 0.01) {
            toplamElement.parentElement.className = 'alert alert-success';
        } else {
            toplamElement.parentElement.className = 'alert alert-warning';
        }
    }
    
    function hesaplaNotToplam() {
        const notlar = [
            'ogretmen_notu_agirlik',
            'ogrenci_notu_agirlik'
        ];
        
        let toplam = 0;
        notlar.forEach(name => {
            const input = document.querySelector(`[name="${name}"]`);
            if (input) {
                toplam += parseFloat(input.value) || 0;
            }
        });
        
        const toplamElement = document.getElementById('not-toplam');
        toplamElement.textContent = toplam.toFixed(2);
        
        if (Math.abs(toplam - 100) < 0.01) {
            toplamElement.parentElement.className = 'alert alert-success';
        } else {
            toplamElement.parentElement.className = 'alert alert-warning';
        }
    }
    
    function updateSaveButton() {
        const kriterToplam = parseFloat(document.getElementById('kriter-toplam').textContent) || 0;
        const notToplam = parseFloat(document.getElementById('not-toplam').textContent) || 0;
        const okKriter = Math.abs(kriterToplam - 100) < 0.01;
        const okNot = Math.abs(notToplam - 100) < 0.01;
        const btn = document.getElementById('save-btn');
        if (btn) {
            btn.disabled = !(okKriter && okNot);
        }
    }

    function recalcAll() {
        hesaplaKriterToplam();
        hesaplaNotToplam();
        updateSaveButton();
    }

    function normalizeKriterlerTo100() {
        const kriterler = [
            'konu_hakimiyeti_agirlik',
            'anlatim_agirlik',
            'giyim_agirlik',
            'ekip_uyumu_agirlik',
            'gorsellik_agirlik',
            'genel_gorus_agirlik'
        ];

        const values = kriterler.map(name => clamp01to100(document.querySelector(`input.weight-range[data-target="${name}"]`)?.value || 0));
        const total = values.reduce((a, b) => a + b, 0);

        if (total <= 0) {
            const base = Math.floor(100 / kriterler.length);
            let sum = 0;
            kriterler.forEach((name, idx) => {
                const v = (idx === kriterler.length - 1) ? (100 - sum) : base;
                sum += v;
                setValue(name, v);
            });
            return;
        }

        const factor = 100 / total;
        const scaled = values.map(v => v * factor);
        const rounded = scaled.map(v => Math.floor(v));
        let sumRounded = rounded.reduce((a, b) => a + b, 0);
        let remainder = 100 - sumRounded;

        const order = scaled
            .map((v, idx) => ({ idx, frac: v - Math.floor(v) }))
            .sort((a, b) => b.frac - a.frac);

        for (let i = 0; i < order.length && remainder > 0; i++) {
            rounded[order[i].idx] += 1;
            remainder -= 1;
        }

        kriterler.forEach((name, idx) => {
            setValue(name, rounded[idx]);
        });
    }

    function clamp01to100(v) {
        const n = parseFloat(v);
        if (Number.isNaN(n)) return 0;
        return Math.min(100, Math.max(0, n));
    }

    function updateNotWeightsFrom(sourceName, value) {
        const v = clamp01to100(value);
        if (sourceName === 'ogretmen_notu_agirlik') {
            setValue('ogretmen_notu_agirlik', v);
            setValue('ogrenci_notu_agirlik', (100 - v));
        } else if (sourceName === 'ogrenci_notu_agirlik') {
            setValue('ogrenci_notu_agirlik', v);
            setValue('ogretmen_notu_agirlik', (100 - v));
        }
    }

    document.querySelectorAll('input.weight-range').forEach(range => {
        range.addEventListener('input', function() {
            const name = this.getAttribute('data-target');
            if (name === 'ogretmen_notu_agirlik' || name === 'ogrenci_notu_agirlik') {
                updateNotWeightsFrom(name, this.value);
            } else {
                syncFromRange(this);
            }
            recalcAll();
        });
    });

    const kriterNormalize = document.getElementById('kriter-normalize');
    if (kriterNormalize) {
        kriterNormalize.addEventListener('click', function () {
            normalizeKriterlerTo100();
            recalcAll();
        });
    }

    const presetDengeli = document.getElementById('preset-dengeli');
    if (presetDengeli) {
        presetDengeli.addEventListener('click', function () {
            setValue('konu_hakimiyeti_agirlik', 15);
            setValue('anlatim_agirlik', 15);
            setValue('giyim_agirlik', 5);
            setValue('ekip_uyumu_agirlik', 10);
            setValue('gorsellik_agirlik', 35);
            setValue('genel_gorus_agirlik', 20);
            recalcAll();
        });
    }

    const presetSunum = document.getElementById('preset-sunum');
    if (presetSunum) {
        presetSunum.addEventListener('click', function () {
            setValue('konu_hakimiyeti_agirlik', 12.5);
            setValue('anlatim_agirlik', 12.5);
            setValue('giyim_agirlik', 5);
            setValue('ekip_uyumu_agirlik', 10);
            setValue('gorsellik_agirlik', 45);
            setValue('genel_gorus_agirlik', 15);
            recalcAll();
        });
    }

    const presetNotDengeli = document.getElementById('preset-not-dengeli');
    if (presetNotDengeli) {
        presetNotDengeli.addEventListener('click', function () {
            setValue('ogretmen_notu_agirlik', 60);
            setValue('ogrenci_notu_agirlik', 40);
            recalcAll();
        });
    }

    const presetNotOgretmen = document.getElementById('preset-not-ogretmen');
    if (presetNotOgretmen) {
        presetNotOgretmen.addEventListener('click', function () {
            updateNotWeightsFrom('ogretmen_notu_agirlik', 70);
            recalcAll();
        });
    }

    document.querySelectorAll('input.weight-range').forEach(range => {
        syncFromRange(range);
    });
    updateNotWeightsFrom('ogretmen_notu_agirlik', document.querySelector('input.weight-range[data-target="ogretmen_notu_agirlik"]')?.value || 0);
    
    recalcAll();
</script>
{% endblock %}



